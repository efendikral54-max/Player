<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>TV Player Sound Force</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  body { margin: 0; background: #000; overflow: hidden; height: 100vh; display: flex; align-items: center; justify-content: center; }
  video { width: 100%; height: 100vh; object-fit: contain; }
</style>
</head>
<body>

<video id="video" playsinline autoplay></video>

<script>
  var video = document.getElementById('video');
  var hls = null;
  var sonUrl = "";

  function erzwingeTonUndPlay() {
    // Wir sagen dem Video: Sei laut!
    video.muted = false;
    video.volume = 1.0;

    var playPromise = video.play();

    if (playPromise !== undefined) {
        playPromise.then(_ => {
            console.log("Wiedergabe l채uft mit Ton!");
        }).catch(error => {
            // Falls Android den Ton blockiert, m체ssen wir es 
            // leider kurz stumm starten, damit das Bild kommt...
            console.log("Ton blockiert, erzwinge Bild...");
            video.muted = true;
            video.play();
            
            // ...aber wir versuchen danach jede Sekunde, den Ton wieder einzuschalten!
            var retryAudio = setInterval(() => {
                video.muted = false;
                video.play();
                if (!video.muted) { 
                    clearInterval(retryAudio); 
                    console.log("Ton wurde nachtr채glich befreit!");
                }
            }, 1000);
        });
    }
  }

  // WACHHUND: Pr체ft alle 800ms ob das Video pausiert ist oder stumm geschaltet wurde
  setInterval(function() {
    if (sonUrl !== "") {
      if (video.paused) {
        console.log("Video gestoppt -> Neustart!");
        erzwingeTonUndPlay();
      }
      if (video.muted) {
        console.log("Video ist stumm -> Ton an!");
        video.muted = false;
      }
    }
  }, 800);

  // Falls der Stream zu Ende ist oder hakt -> Sofort wieder Play
  video.addEventListener('ended', erzwingeTonUndPlay);
  video.addEventListener('pause', erzwingeTonUndPlay);

  function loadStream(url) {
    if (!url) return;
    if (hls) hls.destroy();

    if (Hls.isSupported()) {
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, erzwingeTonUndPlay);
    } else {
      video.src = url;
      erzwingeTonUndPlay();
    }
  }

  // Kodular-Briefkasten abfragen
  setInterval(function() {
    var link = window.AppInventor.getWebViewString();
    if (link && link !== sonUrl) {
      sonUrl = link;
      loadStream(link);
    }
  }, 500);

  // WICHTIG: Fernbedienungs-Taste schaltet Ton sofort frei
  window.addEventListener('keydown', function() {
    video.muted = false;
    video.play();
  });
</script>
</body>
</html>

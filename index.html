<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Non-Stop TV Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  body { margin: 0; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; }
  video { width: 100%; height: 100vh; object-fit: contain; }
</style>
</head>
<body>

<video id="video" playsinline></video>

<script>
  var video = document.getElementById('video');
  var hls = null;
  var sonUrl = "";
  var isAttemptingPlay = false;

  // Die Hauptfunktion zum Abspielen
  function forcePlay() {
    if (isAttemptingPlay) return; // Verhindert Endlosschleifen-Fehler
    isAttemptingPlay = true;

    // Versuche mit Ton zu starten
    video.muted = false;
    video.volume = 1.0;

    var playPromise = video.play();

    if (playPromise !== undefined) {
      playPromise.then(_ => {
        isAttemptingPlay = false;
        console.log("Wiedergabe läuft mit Ton");
      })
      .catch(error => {
        // Wenn der Browser blockiert (wegen Ton), starte stumm und versuche es gleich wieder
        console.log("Autoplay blockiert, starte stumm...");
        video.muted = true;
        video.play();
        isAttemptingPlay = false;
      });
    } else {
      isAttemptingPlay = false;
    }
  }

  // EVENT: Wenn das Video pausiert wird (warum auch immer), sofort wieder starten
  video.addEventListener('pause', function() {
    console.log("Pause erkannt! Erzwinge Fortsetzung...");
    forcePlay();
  });

  // WACHHUND: Alle 1 Sekunde prüfen, ob das Video feststeckt
  setInterval(function() {
    if (video.paused && sonUrl !== "") {
      forcePlay();
    }
  }, 1000);

  function loadStream(streamURL) {
    if (!streamURL) return;
    if (hls) { hls.destroy(); }

    if(Hls.isSupported()) {
      hls = new Hls({ enableWorker: true });
      hls.loadSource(streamURL);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        forcePlay();
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = streamURL;
      forcePlay();
    }
  }

  // Kodular-Abfrage
  setInterval(function() {
    var kodularUrl = window.AppInventor.getWebViewString();
    if (kodularUrl && kodularUrl !== sonUrl) {
      sonUrl = kodularUrl;
      loadStream(kodularUrl);
    }
  }, 500);

  // Einmaliger Klick schaltet für immer den Ton frei (Browser-Sicherheit)
  function freischalten() {
    video.muted = false;
    forcePlay();
  }
  window.addEventListener('click', freischalten);
  window.addEventListener('keydown', freischalten);

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kodular HLS Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  /* Macht den Hintergrund komplett schwarz und verhindert Scrollbalken */
  body { margin: 0; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; }
  /* object-fit: contain sorgt dafür, dass das Bildformat nicht verzerrt wird */
  video { width: 100%; height: 100vh; object-fit: contain; }
</style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>

<script>
  var video = document.getElementById('video');
  var hls = null;
  var sonUrl = ""; // Merkt sich den zuletzt geladenen Link

  // Diese Funktion lädt den eigentlichen Stream
  function loadStream(streamURL) {
    if (!streamURL) return;

    // Alten Stream sauber beenden, wenn umgeschaltet wird
    if (hls) {
      hls.destroy();
    }

    if(Hls.isSupported()) {
      hls = new Hls({
        enableWorker: true
      });
      hls.loadSource(streamURL);
      hls.attachMedia(video);
      
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        // Promise-Struktur aus deinem Code (Sehr gut für Fehlervermeidung!)
        var playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise.then(_ => {
            console.log("Video başladı.");
          })
          .catch(error => {
            console.log("Otomatik oynatma engellendi, kullanıcı etkileşimi bekleniyor.");
          });
        }
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      // Fallback für native HLS-Unterstützung
      video.src = streamURL;
      video.addEventListener('loadedmetadata', function() {
        video.play();
      });
    }
  }

  // Die Kodular-Verbindung: Prüft regelmäßig auf neue Links
  setInterval(function() {
    var kodularUrl = window.AppInventor.getWebViewString();
    
    // Wenn ein neuer Link aus der App kommt, lade ihn!
    if (kodularUrl && kodularUrl !== sonUrl) {
      sonUrl = kodularUrl;
      loadStream(kodularUrl);
    }
  }, 500);

  // Zwingt den Ton an, sobald der Nutzer eine Taste auf der Fernbedienung drückt
  function sesiAc() {
    if (video.muted) {
      video.muted = false;
      video.play();
    }
  }

  window.addEventListener('click', sesiAc);
  window.addEventListener('keydown', sesiAc);

</script>

</body>
</html>
